<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Thompson Sampling â€“ Ads Optimizer</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Recharts (UMD) -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <!-- Babel (so we can write JSX directly in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <!-- Your app code -->
    <script type="text/babel" data-presets="react">
      const { useMemo, useState } = React;
      const {
        LineChart, Line, XAxis, YAxis, Tooltip, Legend,
        CartesianGrid, ResponsiveContainer
      } = Recharts;

      const DEFAULT_ADS = [
        { id: 1, name: "Ad A â€“ ðŸ¤£ Funny", emoji: "ðŸ¤£" },
        { id: 2, name: "Ad B â€“ ðŸ§  Serious", emoji: "ðŸ§ " },
        { id: 3, name: "Ad C â€“ ðŸ¥º Emotional", emoji: "ðŸ¥º" },
      ];

      function sampleBeta(alpha, beta) {
        function sampleGamma(k) {
          const d = k < 1 ? k + (1 - k) : k - 1 / 3;
          const c = 1 / Math.sqrt(9 * d);
          while (true) {
            let x, v, u;
            do {
              const u1 = Math.random();
              const u2 = Math.random();
              x = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
              v = 1 + c * x;
            } while (v <= 0);
            v = v * v * v;
            u = Math.random();
            if (u < 1 - 0.0331 * (x * x) * (x * x)) return d * v;
            if (Math.log(u) < 0.5 * x * x + d * (1 - v + Math.log(v))) return d * v;
          }
        }
        const a = alpha <= 0 ? 1e-9 : alpha;
        const b = beta <= 0 ? 1e-9 : beta;
        const x = sampleGamma(a);
        const y = sampleGamma(b);
        return x / (x + y);
      }

      function formatPct(x) {
        return `${(x * 100).toFixed(1)}%`;
      }
      function clamp01(x) {
        if (Number.isNaN(x)) return 0;
        return Math.max(0, Math.min(1, x));
      }

      function Stat({ label, value }) {
        return (
          <div className="flex items-center justify-between text-sm py-1">
            <span className="text-gray-500">{label}</span>
            <span className="font-semibold">{value}</span>
          </div>
        );
      }

      function ThompsonAdsDemo() {
        const [ads, setAds] = useState(
          DEFAULT_ADS.map((ad, i) => ({
            ...ad,
            alphaC: 1, betaC: 1,
            alphaB: 1, betaB: 1,
            shown: 0, ignored: 0, clicked: 0, bought: 0, chosenCount: 0,
            truthClick: [0.10, 0.05, 0.20][i],
            truthBuy:   [0.02, 0.01, 0.05][i],
          }))
        );
        const [valueClick, setValueClick] = useState(1);
        const [valueBuy, setValueBuy] = useState(3);
        const [round, setRound] = useState(0);
        const [currentIndex, setCurrentIndex] = useState(null);
        const [pickCount, setPickCount] = useState(0);
        const [flash, setFlash] = useState(false);
        const [cumReward, setCumReward] = useState(0);
        const [history, setHistory] = useState([]);
        const [importRows, setImportRows] = useState(
          DEFAULT_ADS.map(() => ({ shown: 0, clicks: 0, buys: 0 }))
        );

        const nextAdIndex = useMemo(() => {
          let bestIndex = 0, bestScore = -Infinity;
          ads.forEach((ad, idx) => {
            const pClick = sampleBeta(ad.alphaC, ad.betaC);
            const pBuy = sampleBeta(ad.alphaB, ad.betaB);
            const score = valueClick * pClick + valueBuy * pBuy;
            if (score > bestScore) { bestScore = score; bestIndex = idx; }
          });
          return bestIndex;
        }, [ads, valueClick, valueBuy, round]);

        function pickNext() {
          const idx = nextAdIndex;
          setCurrentIndex(idx);
          setPickCount(c => c + 1);
          setFlash(true); setTimeout(() => setFlash(false), 500);
          setRound(r => r + 1);
          setAds(prev => prev.map((ad, i) =>
            i === idx ? { ...ad, chosenCount: ad.chosenCount + 1, shown: ad.shown + 1 } : ad
          ));
        }

        function onIgnore() {
          if (currentIndex == null) return;
          const idx = currentIndex;
          setAds(prev => prev.map((ad, i) =>
            i === idx ? { ...ad, ignored: ad.ignored + 1, betaC: ad.betaC + 1, betaB: ad.betaB + 1 } : ad
          ));
        }
        function onClick() {
          if (currentIndex == null) return;
          const idx = currentIndex;
          setAds(prev => prev.map((ad, i) =>
            i === idx ? { ...ad, clicked: ad.clicked + 1, alphaC: ad.alphaC + 1, betaB: ad.betaB + 1 } : ad
          ));
        }
        function onBuy() {
          if (currentIndex == null) return;
          const idx = currentIndex;
          setAds(prev => prev.map((ad, i) =>
            i === idx ? { ...ad, clicked: ad.clicked + 1, bought: ad.bought + 1, alphaC: ad.alphaC + 1, alphaB: ad.alphaB + 1 } : ad
          ));
        }

        const currentAd = currentIndex != null ? ads[currentIndex] : null;

        return (
          <div className="min-h-screen w-full bg-gray-50 text-gray-900 p-6">
            <div className="max-w-4xl mx-auto">
              <h1 className="text-2xl font-bold mb-4">Thompson Sampling â€“ Ads Optimizer</h1>

              <button onClick={pickNext} className="mb-4 rounded-xl px-4 py-2 bg-black text-white">Pick Next Ad</button>

              {currentAd && (
                <div className={`p-4 rounded-2xl border mb-4 ${flash ? 'ring-4 ring-blue-300 bg-blue-50' : ''}`}>
                  <div className="text-3xl">{currentAd.emoji}</div>
                  <div>{currentAd.name}</div>
                  <div className="text-sm text-gray-500">Chosen: {currentAd.chosenCount} â€¢ Shown: {currentAd.shown}</div>
                  <div className="flex gap-2 mt-2">
                    <button onClick={onIgnore} className="rounded bg-gray-200 px-3 py-1">Ignore</button>
                    <button onClick={onClick} className="rounded bg-blue-200 px-3 py-1">Click</button>
                    <button onClick={onBuy} className="rounded bg-green-200 px-3 py-1">Buy</button>
                  </div>
                </div>
              )}

              <h2 className="font-semibold mb-2">Stats</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {ads.map(ad => {
                  const meanClick = ad.alphaC / (ad.alphaC + ad.betaC);
                  const meanBuy = ad.alphaB / (ad.alphaB + ad.betaB);
                  const ev = valueClick * meanClick + valueBuy * meanBuy;
                  return (
                    <div key={ad.id} className="bg-white rounded-xl shadow p-4">
                      <div className="text-lg font-semibold mb-2">{ad.name}</div>
                      <Stat label="Shown" value={ad.shown} />
                      <Stat label="Clicks" value={ad.clicked} />
                      <Stat label="Buys" value={ad.bought} />
                      <div className="border-t my-2" />
                      <Stat label="CTR belief" value={formatPct(meanClick)} />
                      <Stat label="CVR belief" value={formatPct(meanBuy)} />
                      <Stat label="Expected Value" value={ev.toFixed(2)} />
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      // Mount React
      const container = document.getElementById("root");
      if (ReactDOM.createRoot) {
        ReactDOM.createRoot(container).render(<ThompsonAdsDemo />);
      } else {
        ReactDOM.render(<ThompsonAdsDemo />, container);
      }
    </script>
  </body>
</html>
